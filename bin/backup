#!/usr/bin/env bash

# TODO: Try to use rsync directly with --progress2 key

# Backs up all the things to the Synology NAS.
#
# - Run the backup:
#
# `backup`
#
# ---
#
# If nothing happens but there's a ðŸ”’ icon on the progress bar, type your
# password and press Enter.
#
# If you get an error "The authenticity of host 'hippopotamus.local (...)' can't
# be established", run this command:
#    ssh sapegin@Hippopotamus.local
#
# Prerequisites:
# 1. Update rsync:
#    brew install rsync
# 2. Install rsyncy:
#    brew install rsyncy
# 2. Enable SSH service on Synology NAS:
#    Control Panel -> Terminal & SNMP -> Terminal -> Enable SSH service
# 3. Enable rsync service on Synology NAS:
#    Control Panel -> File Services -> rsync -> Enable rsync service
# 4. Enable User home on Synology NAS:
#    Control Panel -> User & Group -> Advanced -> User Home -> Enable user home service
# 5. Generate SSH key
#    ssh-key
# 6. Upload SSH key to Synology NAS:
#    ssh-copy-id sapegin@Hippopotamus.local
#
# Author: Artem Sapegin, sapegin.me
# License: MIT
# https://github.com/sapegin/dotfiles

DEST="sapegin@Hippopotamus.local:/volume1"
RSYNC_OPTS="--archive --delete --delete-excluded --one-file-system --human-readable --partial -e ssh --exclude '.DS_Store'"

set -e

# Common stuff
RED="$(tput setaf 1)"
CYAN="$(tput setaf 6)"
UNDERLINE="$(tput sgr 0 1)"
NOCOLOR="$(tput sgr0)"
function error() { echo -e "$UNDERLINE$RED$1$NOCOLOR\n"; }
function heading() { echo -e "$UNDERLINE$CYAN$1$NOCOLOR\n"; }

function bk() {
	heading "Backing up $1""â€¦"
	rsyncy $RSYNC_OPTS "$1" "$DEST/$2"
}

command -v rsyncy > /dev/null 2>&1 || {
	echo >&2 "rsyncy is not installed: brew install rsyncy"
	exit 1
}

# TODO: Backup notes separately in a dated zip file

# Obsidian vault
bk "$HOME/murder/" "Stuffses/Backups/Obsidian"

# iCloud Drive documents
bk "$HOME/cloud/" "Stuffses/Backups/iCloud"
