#!/usr/bin/env node

// Magic project opener: opens repository using fuzzy search.
//
// Should be used via Bash alias like this:
//   function proj { cd "$("$HOME/dotfiles/bin/repo" $1)"; }
//
// Author: Artem Sapegin, sapegin.me
// License: MIT
// https://github.com/sapegin/dotfiles
//

'use strict';

const fs = require('fs');
const path = require('path');

const PROJECTS_DIR = path.join(process.env.HOME, 'Dropbox/Projects');
const SKIP_PREFIXES = ['_Repos', 'Misc'];

const args = process.argv.splice(2);
if (args.length !== 1) {
	console.log('Usage: repo <name>');
	process.exit(1);
}

const repo = find(getRepos(PROJECTS_DIR), args[0]);
if (repo) {
	console.log(path.join(PROJECTS_DIR, repo));
}

function find(repos, name) {
	// Fuzzy search
	const nameRegexp = new RegExp(
		name
			.replace(/[^a-z0-9]/gi, '')
			.split('')
			.join('.*'),
		'i'
	);
	const filterRegexp = new RegExp('^(' + SKIP_PREFIXES.join('|') + ')/', 'i');
	repos = repos.filter(function(repo) {
		repo = repo.replace(filterRegexp, '');
		return nameRegexp.test(repo);
	});

	// Found?
	if (!repos.length) {
		console.log('Repository not found');
		process.exit(1);
	}

	// Order by repo nameâ€™s length
	const length = function(repo) {
		return path.basename(repo).length;
	};
	repos.sort(function(a, b) {
		return length(a) > length(b);
	});

	// Return the most probable result
	return repos[0];
}

function getRepos(dir) {
	const projects = getDirs(dir);
	const repos = [];
	projects.forEach(function(projectName) {
		const projectDir = path.join(dir, projectName);
		const subDirs = getDirs(projectDir);
		subDirs.forEach(function(subDirName) {
			if (fs.existsSync(path.join(projectDir, subDirName, '.git'))) {
				repos.push(path.join(projectName, subDirName));
			}
		});
	});

	return repos;
}

function getDirs(dir) {
	return fs.readdirSync(dir).filter(file => fs.statSync(path.join(dir, file)).isDirectory());
}
