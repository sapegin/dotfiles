#!/usr/bin/env node

// Gets themes from the Squirrelsong repo or a local repository clone.
//
// - Sync colors from GitHub:
//
// `sync-colors`
//
// - Sync colors from a local folder:
//
// `sync-colors local`
//
// ---
// Author: Artem Sapegin, sapegin.me
// License: MIT
// https://github.com/sapegin/dotfiles

// Supports themes for the following apps:
// - [x] Bat
// - [x] Bear
// - [x] Peek
// - [x] Fzf
// - [x] Ghostty
// - [x] dotfiles/brain

import path from 'node:path';
import fs from 'node:fs';
import os from 'node:os';
import { execSync } from 'node:child_process';

const HOME = os.homedir();

const SKIP_SUDO = false;

const IS_LOCAL = process.argv.includes('local');

const REPO_ROOT =
	'https://raw.githubusercontent.com/sapegin/squirrelsong/master';
const LOCAL_ROOT = `${HOME}/_/squirrelsong`;
const DEST_DIR = `${HOME}/dotfiles/tilde`;

function stripJsonComments(json) {
	return (
		json
			// Remove /* */ comments
			.replace(/\/\*[\s\S]*?\*\//g, '')
			// Remove // comments
			.replace(/\/\/.*$/gm, '')
	);
}

async function download(filepath) {
	if (IS_LOCAL) {
		const fullPath = path.join(LOCAL_ROOT, filepath);
		return fs.readFileSync(fullPath, 'utf8');
	} else {
		const url = `${REPO_ROOT}/${encodeURI(filepath)}`;
		const res = await fetch(url);
		if (res.ok === false) {
			console.error(`Cannot download ${url}`);
			console.error(`${res.status}: ${res.statusText}`);
			process.exit(1);
		}
		return res.text();
	}
}

function read(filepath) {
	return fs.readFileSync(filepath, 'utf8');
}

function write(file, text) {
	const fullPath = file.startsWith('/') ? file : path.join(DEST_DIR, file);
	fs.mkdirSync(path.dirname(fullPath), { recursive: true });
	return fs.writeFileSync(fullPath, text);
}

async function install(from, toDir) {
	const theme = await download(from);
	const filename = path.basename(from);
	write(path.join(toDir, filename), theme);
}

/**
 * Bat: https://github.com/sharkdp/bat?tab=readme-ov-file#adding-new-themes
 */

console.log('ðŸŒˆ Installing Bat themeâ€¦');

await install(
	'themes/Sublime Text/Squirrelsong Dark Deep Purple/Squirrelsong Dark Deep Purple.tmTheme',
	'.config/bat/themes'
);
execSync(`bat cache --build`);

/**
 * Ghostty
 */

console.log('ðŸŒˆ Installing Ghostty themeâ€¦');

await install('themes/Ghostty/Squirrelsong Dark', '.config/ghostty/themes');
await install(
	'themes/Ghostty/Squirrelsong Dark Deep Purple',
	'.config/ghostty/themes'
);

/**
 * Peek
 */

const peekThemeDir = `${HOME}/Library/Group Containers/9V456WSURS.com.bigzlabs.peekgroup/Library/Application Support/Styles`;

if (fs.existsSync(peekThemeDir)) {
	console.log('ðŸŒˆ Installing Peek themeâ€¦');
	const peekTheme = await download('themes/Peek/custom.css');
	write(path.join(peekThemeDir, 'custom.css'), peekTheme);
}

/**
 * Fzf
 */

console.log('ðŸŒˆ Installing fzf themeâ€¦');

const fzfThemeRegExp = /FZF_DEFAULT_OPTS=["'][^'"]+["']/g;
const fzfThemeReadme = await download('themes/Fzf/Readme.md');
const zshRcFile = `${HOME}/dotfiles/tilde/.zshrc`;
const fzfThemeTheme = fzfThemeReadme.match(fzfThemeRegExp)[1] ?? '';
const zshRc = read(zshRcFile);
const zshRcUpdated = zshRc.replace(fzfThemeRegExp, fzfThemeTheme);
write(zshRcFile, zshRcUpdated);

console.log('   ðŸ’¡ Reopen your terminal to take effect');

/**
 * dotfiles/brain
 */

const brainThemeDir = `${HOME}/dotfiles/colors/shiki`;

console.log('ðŸŒˆ Installing dotfiles/brain themeâ€¦');
const brainTheme = stripJsonComments(
	await download(
		'themes/VSCode/SquirrelsongLight/SquirrelsongLight.color-theme.json'
	)
);
write(
	path.join(brainThemeDir, 'SquirrelsongLight.color-theme.json'),
	brainTheme
);

/**
 * Bear
 */

if (SKIP_SUDO === false) {
	console.log('ðŸŒˆ Installing Bear themeâ€¦');

	const bearTheme = await download('themes/Bear/Squirrelsong Light.theme');
	const bearThemesDir = `/Applications/Bear.app/Contents/Frameworks/BearCore.framework/Resources`;
	const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'dotfiles-'));
	const tempFile = path.join(tempDir, 'theme');
	write(tempFile, bearTheme);
	execSync(
		`sudo -- sh -c 'command rm "${bearThemesDir}/Ayu.theme" > /dev/null 2>&1; command cp "${tempFile}" "${bearThemesDir}/Ayu.theme"'`
	);
	fs.rmSync(tempDir, { recursive: true, force: true });
	console.log('   ðŸ’¡ Now choose Ayu theme in Bear settings');
}

// --- 8< -- 8< ---

console.log();
console.log('ðŸ¦œ Install all the remaining themes at:');
console.log('https://sapegin.me/squirrelsong/#download');
