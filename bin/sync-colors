#!/usr/bin/env node

// Gets themes from the Squirrelsong repo:
// > [x] Bat
// > [x] Bear
// > [x] Peek
// > [x] Fzf
// > [x] Ghostty
//
// ---
// Author: Artem Sapegin, sapegin.me
// License: MIT
// https://github.com/sapegin/dotfiles

import path from 'node:path';
import fs from 'node:fs';
import os from 'node:os';
import { execSync } from 'node:child_process';
import ky from 'ky';
import { temporaryFileTask } from 'tempy';

const HOME = os.homedir();

const SKIP_SUDO = false;

const REPO_ROOT =
	'https://raw.githubusercontent.com/sapegin/squirrelsong/master';
const DEST_DIR = `${HOME}/dotfiles/tilde`;

function download(filepath) {
	return ky.get(`${REPO_ROOT}/${encodeURI(filepath)}`).text();
}

function read(filepath) {
	return fs.readFileSync(filepath, 'utf8');
}

function write(file, text) {
	const fullPath = file.startsWith('/') ? file : path.join(DEST_DIR, file);
	fs.mkdirSync(path.dirname(fullPath), { recursive: true });
	return fs.writeFileSync(fullPath, text);
}

async function install(from, toDir) {
	const theme = await download(from);
	const filename = path.basename(from);
	write(path.join(toDir, filename), theme);
}

/**
 * Bat: https://github.com/sharkdp/bat?tab=readme-ov-file#adding-new-themes
 */

console.log('ðŸŒˆ Installing Bat themeâ€¦');

await install(
	'themes/Sublime Text/Squirrelsong Dark/Squirrelsong Dark.tmTheme',
	'.config/bat/themes'
);
execSync(`bat cache --build`);

/**
 * Ghostty
 */

console.log('ðŸŒˆ Installing Ghostty themeâ€¦');

await install('themes/Ghostty/Squirrelsong Dark', '.config/ghostty/themes');

/**
 * Peek
 */

const peekThemeDir = `${HOME}/Library/Group Containers/9V456WSURS.com.bigzlabs.peekgroup/Library/Application Support/Styles`;

if (fs.existsSync(peekThemeDir)) {
	console.log('ðŸŒˆ Installing Peek themeâ€¦');
	const peekTheme = await download('themes/Peek/custom.css');
	write(path.join(peekThemeDir, 'custom.css'), peekTheme);
}

/**
 * Bear
 */

if (SKIP_SUDO === false) {
	console.log('ðŸŒˆ Installing Bear themeâ€¦');

	const bearTheme = await download('themes/Bear/Squirrelsong Light.theme');
	const bearThemesDir = `/Applications/Bear.app/Contents/Frameworks/BearCore.framework/Resources`;
	await temporaryFileTask((tempFile) => {
		write(tempFile, bearTheme);
		execSync(
			`sudo -- sh -c 'command rm "${bearThemesDir}/Ayu.theme" > /dev/null 2>&1; command cp "${tempFile}" "${bearThemesDir}/Ayu.theme"'`
		);
	});
	console.log('ðŸ’¡ Now choose Ayu theme in Bear settings');
}

/**
 * Fzf
 */

console.log('ðŸŒˆ Installing fzf themeâ€¦');

const fzfThemeRegExp = /FZF_DEFAULT_OPTS=["'][^'"]+["']/;
const fzfThemeReadme = await download('themes/Fzf/Readme.md');
const zshRcFile = `${HOME}/dotfiles/tilde/.zshrc`;
const fzfThemeTheme = fzfThemeReadme.match(fzfThemeRegExp)[0] ?? '';
const zshRc = read(zshRcFile);
const zshRcUpdated = zshRc.replace(fzfThemeRegExp, fzfThemeTheme);
write(zshRcFile, zshRcUpdated);

console.log('ðŸ’¡ Reopen your terminal to take effect');

// --- 8< -- 8< ---

console.log();
console.log('ðŸ¦œ Install all the remaining themes at:');
console.log('https://sapegin.me/squirrelsong/#download');
