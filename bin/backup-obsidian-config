#!/usr/bin/env node

// Backs up Obsidian config files.
//
// ---
// Author: Artem Sapegin, sapegin.me
// License: MIT
// https://github.com/sapegin/dotfiles

import path from 'node:path';
import fs from 'node:fs/promises';
import os from 'node:os';

const untildify = (x) => x.replace(/^~/, os.homedir());

const DEST_DIR = path.join(import.meta.dirname, '/../obsidian');
const EXCLUDED_FILES = ['workspace.json', 'workspace-mobile.json'];
const DIRS_TO_BACKUP = [
	path.join('~/sewer/.obsidian'),
	path.join('~/sewer/templates'),
	path.join('~/sewer/bases'),
];

async function copyFile(source, dest) {
	await fs.mkdir(path.dirname(dest), { recursive: true });
	await fs.copyFile(source, dest);
}

async function copyDirectory(source, dest) {
	const entries = await fs.readdir(source, { withFileTypes: true });

	for (const entry of entries) {
		const sourcePath = path.join(source, entry.name);
		const destPath = path.join(dest, entry.name);

		if (entry.isDirectory()) {
			await copyDirectory(sourcePath, destPath);
		} else if (entry.isFile()) {
			if (EXCLUDED_FILES.includes(entry.name)) {
				console.log(`Skipping ${entry.name}â€¦`);
				continue;
			}
			await copyFile(sourcePath, destPath);
		}
	}
}

console.log();
console.log('Backing up Obsidian configsâ€¦ ðŸ§ ');

try {
	for (const from of DIRS_TO_BACKUP) {
		console.log('ðŸ‘‰', from);
		const to = path.join(DEST_DIR, path.basename(from));
		await copyDirectory(untildify(from), to);
	}
	console.log();
	console.log('Done ðŸ¦œ');
} catch (error) {
	console.error();
	console.error('Error:', error.message);
	process.exit(1);
}
